<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LifeOS Dev Console</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg-primary:#0b1220;
  --bg-secondary:#121a2b;
  --bg-tertiary:#1e293b;
  --border:#2a354a;
  --text-primary:#e2e8f0;
  --text-secondary:#94a3b8;
  --accent:#6366f1;
  --success:#10b981;
  --error:#ef4444;
  --warning:#f59e0b;
}

body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden;}

.app{display:grid;grid-template-columns:220px 1fr 420px;height:100vh;}
@media(max-width:1200px){.app{grid-template-columns:220px 1fr;}.terminal-panel{display:none;}}

.sidebar{background:var(--bg-secondary);border-right:1px solid var(--border);padding:16px 12px;}
.sidebar h1{font-size:13px;color:var(--text-secondary);margin-bottom:18px;letter-spacing:.6px;}
.menu{display:flex;flex-direction:column;gap:6px;}
.menu a{color:var(--text-secondary);text-decoration:none;font-size:13px;padding:10px;border-radius:8px;border:1px solid transparent;}
.menu a:hover{background:var(--bg-tertiary);color:#fff;}
.menu a.active{background:var(--bg-tertiary);border-color:var(--accent);color:#fff;}

.main{display:flex;flex-direction:column;height:100%;overflow:hidden;}

.topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--bg-secondary);font-size:12px;}
.endpoint{font-family:monospace;color:var(--text-secondary);}
.btn{border:none;background:var(--bg-tertiary);color:#fff;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer;}
.btn:hover{background:#334155;}

.status-badge{padding:2px 8px;border-radius:6px;font-size:11px;margin-left:10px;}
.status-online{background:rgba(16,185,129,.2);color:var(--success);}
.status-offline{background:rgba(239,68,68,.2);color:var(--error);}

.content{padding:20px;overflow:auto;height:100%;}
.card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;margin-bottom:16px;}
.card-header{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;}
.card-body{padding:16px;}

input,textarea{width:100%;background:var(--bg-primary);border:1px solid var(--border);color:#fff;padding:10px;border-radius:8px;font-family:monospace;font-size:13px;}
input:focus,textarea:focus{outline:none;border-color:var(--accent);}

.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
button.action{margin-top:12px;width:100%;padding:10px;border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;}
.primary{background:var(--accent);color:#fff;}
.success{background:var(--success);color:#000;}
.warning{background:var(--warning);color:#000;}
.danger{background:var(--error);color:#fff;}

.response{margin-top:12px;background:#000;border:1px solid var(--border);border-radius:8px;padding:10px;display:none;}
.badge{padding:2px 6px;border-radius:4px;font-size:11px;margin-left:8px;}
.badge-success{background:rgba(16,185,129,.2);color:var(--success);}

.email-card{border:1px solid var(--border);border-radius:8px;margin-bottom:10px;padding:10px;background:#000;}
.token-box{margin-bottom:10px;background:#020617;border:1px dashed var(--border);padding:10px;border-radius:8px;}

.terminal-panel{background:#000;border-left:1px solid var(--border);display:flex;flex-direction:column;}
.terminal-header{display:flex;justify-content:space-between;padding:14px 18px;background:var(--bg-secondary);border-bottom:1px solid var(--border);}
.terminal-body{flex:1;overflow:auto;padding:16px;font-family:monospace;font-size:12px;}
.log-entry{margin-bottom:10px;}
.log-info{color:#60a5fa;}
.log-success{color:#10b981;}
.log-error{color:#ef4444;}
.log-warning{color:#f59e0b;}
</style>
</head>

<body>
<div class="app">

<!-- Sidebar -->
<div class="sidebar">
  <h1>DEV TEST MENU</h1>
  <div class="menu">
    <a href="#" class="active">Auth Tests</a>
    <a href="/users-test.html">User Tests</a>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <div class="endpoint">
      <span id="api-endpoint">http://localhost:3000/api/v1</span>
      <span id="api-status-badge" class="status-badge status-offline"></span>
      <span id="api-status-text">Checking...</span>
    </div>
    <div>
      <button class="btn" onclick="setEndpoint('http://localhost:3000/api/v1')">Local</button>
      <button class="btn" onclick="setEndpoint('http://localhost:3001/api/v1')">Docker</button>
      <button class="btn" onclick="openSwagger()">Swagger</button>
      <button class="btn" onclick="checkEmailInbox()">Inbox</button>
      <button class="btn" onclick="clearAllData()">Reset</button>
    </div>
  </div>

  <div class="content">

    <!-- REGISTER -->
    <div class="card">
      <div class="card-header">Register User</div>
      <div class="card-body">
        <div class="form-grid">
          <input id="reg-email" placeholder="email" />
          <input id="reg-password" placeholder="password" />
          <input id="reg-firstname" placeholder="first name" />
          <input id="reg-lastname" placeholder="last name" />
        </div>
        <button class="btn" onclick="fillRegister()">Auto Fill</button>
        <button class="action primary" onclick="register()">Register</button>

        <div id="register-response" class="response">
          <span id="register-status" class="badge"></span>
          <pre id="register-result"></pre>
        </div>
      </div>
    </div>

    <!-- EMAIL CAPTURE -->
    <div class="card">
      <div class="card-header">Email Capture</div>
      <div class="card-body">
        <input id="check-email" placeholder="email to check inbox" />
        <div style="display:flex;gap:10px;margin-top:10px;">
          <button class="btn" onclick="fetchEmails()">Fetch Emails</button>
          <button class="btn" onclick="clearEmails()">Clear Inbox</button>
        </div>
        <div id="email-list" style="margin-top:12px;"></div>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="card">
      <div class="card-header">Login</div>
      <div class="card-body">
        <div class="form-grid">
          <input id="login-email" placeholder="email" />
          <input id="login-password" placeholder="password" />
        </div>
        <button class="action success" onclick="login()">Login</button>

        <div id="login-response" class="response">
          <span id="login-status" class="badge"></span>
          <pre id="login-result"></pre>
          <div id="token-display"></div>
        </div>
      </div>
    </div>

    <!-- VERIFY -->
    <div class="card">
      <div class="card-header">Verify Email</div>
      <div class="card-body">
        <textarea id="verify-token" placeholder="paste token"></textarea>
        <button class="action warning" onclick="verifyEmail()">Verify Email</button>

        <div id="verify-response" class="response">
          <span id="verify-status" class="badge"></span>
          <pre id="verify-result"></pre>
        </div>
      </div>
    </div>

    <!-- USER -->
    <div class="card">
      <div class="card-header">User Actions</div>
      <div class="card-body">
        <textarea id="user-token" rows="3" placeholder="access token"></textarea>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;">
          <button class="action primary" onclick="getProfile()">Profile</button>
          <button class="action warning" onclick="refreshAccessToken()">Refresh</button>
          <button class="action danger" onclick="logout()">Logout</button>
        </div>

        <div id="user-response" class="response">
          <span id="user-status" class="badge"></span>
          <pre id="user-result"></pre>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Terminal -->
<div class="terminal-panel">
  <div class="terminal-header">
    <span>API Activity Log</span>
    <div>
      <button class="btn" onclick="copyLogs()">Copy</button>
      <button class="btn" onclick="clearLogs()">Clear</button>
    </div>
  </div>
  <div class="terminal-body" id="logger">
    <div class="log-entry log-info">[SYSTEM] Logger initialized...</div>
  </div>
</div>

</div>

<script>
        // Global variables
        window.API_BASE = localStorage.getItem('api-endpoint') || 'http://localhost:3000/api/v1';
        window.accessToken = localStorage.getItem('access-token') || '';
        window.refreshTokenValue = localStorage.getItem('refresh-token') || '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('api-endpoint').textContent = window.API_BASE;
            if (window.accessToken) {
                document.getElementById('user-token').value = window.accessToken;
            }
            checkApiStatus();
            setInterval(checkApiStatus, 30000);
        });

        // Enhanced Logger
        function log(message, type, details) {
            type = type || 'info';
            var logger = document.getElementById('logger');
            var timestamp = new Date().toLocaleTimeString();
            
            var entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            
            var methodMatch = message.match(/(GET|POST|PUT|DELETE|PATCH)/);
            var methodHtml = '';
            if (methodMatch) {
                var method = methodMatch[1].toLowerCase();
                methodHtml = '<span class="log-method log-' + method + '">' + methodMatch[1] + '</span>';
            }
            
            var html = '<span class="log-timestamp">[' + timestamp + ']</span> ' + methodHtml + message;
            
            if (details) {
                html += '<div class="log-details">' + details + '</div>';
            }
            
            entry.innerHTML = html;
            logger.appendChild(entry);
            logger.scrollTop = logger.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logger').innerHTML = '<div class="log-entry log-info"><span class="log-timestamp">[SYSTEM]</span> Logger cleared.</div>';
        }

        function copyLogs() {
            var logger = document.getElementById('logger');
            var text = logger.innerText;
            navigator.clipboard.writeText(text);
            log('Logs copied to clipboard', 'success');
        }

        // API Call with detailed logging
        function apiCall(endpoint, options) {
            options = options || {};
            var url = window.API_BASE + endpoint;
            var method = options.method || 'GET';
            
            // Log request details
            var requestDetails = 'URL: ' + url + '\n';
            requestDetails += 'Method: ' + method + '\n';
            
            var headers = {
                'Content-Type': 'application/json'
            };
            if (window.accessToken) {
                headers['Authorization'] = 'Bearer ' + window.accessToken;
            }
            if (options.headers) {
                Object.assign(headers, options.headers);
            }
            
            requestDetails += 'Headers:\n';
            for (var key in headers) {
                requestDetails += '  ' + key + ': ' + (key === 'Authorization' ? 'Bearer ***' : headers[key]) + '\n';
            }
            
            if (options.body) {
                requestDetails += 'Body: ' + options.body.substring(0, 500) + (options.body.length > 500 ? '...' : '');
            }
            
            log('‚Üí ' + method + ' ' + endpoint, 'info', requestDetails);

            return fetch(url, {
                method: method,
                headers: headers,
                body: options.body
            }).then(function(response) {
                return response.json().then(function(data) {
                    var statusType = response.ok ? 'success' : 'error';
                    var responseDetails = 'Status: ' + response.status + ' ' + response.statusText + '\n';
                    responseDetails += 'Response: ' + JSON.stringify(data, null, 2).substring(0, 1000);
                    if (JSON.stringify(data).length > 1000) {
                        responseDetails += '... (truncated)';
                    }
                    
                    log('‚Üê ' + response.status + ' ' + (response.ok ? 'OK' : 'ERROR'), statusType, responseDetails);
                    
                    return { 
                        success: response.ok, 
                        data: data, 
                        status: response.status,
                        statusText: response.statusText
                    };
                });
            }).catch(function(error) {
                log('‚Üê Network Error: ' + error.message, 'error', error.stack);
                return { success: false, error: error.message };
            });
        }

        // Auth Functions
        function register() {
            var payload = {
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
                firstName: document.getElementById('reg-firstname').value,
                lastName: document.getElementById('reg-lastname').value
            };

            apiCall('/auth/register', {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(function(result) {
                var responseDiv = document.getElementById('register-response');
                var resultPre = document.getElementById('register-result');
                var statusBadge = document.getElementById('register-status');
                
                responseDiv.style.display = 'block';
                resultPre.textContent = JSON.stringify(result.data, null, 2);
                statusBadge.textContent = result.status + ' ' + result.statusText;
                statusBadge.className = 'badge ' + (result.success ? 'badge-success' : '');
                
                if (result.success) {
                    document.getElementById('check-email').value = payload.email;
                    document.getElementById('login-email').value = payload.email;
                    document.getElementById('login-password').value = payload.password;
                    
                    log('‚úÖ Registration successful! Check email capture for verification token.', 'success');
                    
                    setTimeout(function() {
                        fetchEmails();
                        switchTab('email', document.querySelectorAll('.tab')[1]);
                    }, 1500);
                }
            });
        }

        function login() {
    var payload = {
        email: document.getElementById('login-email').value,
        password: document.getElementById('login-password').value
    };

    apiCall('/auth/login', {
        method: 'POST',
        body: JSON.stringify(payload)
    }).then(function(result) {
        var responseDiv = document.getElementById('login-response');
        var resultPre = document.getElementById('login-result');
        var tokenDisplay = document.getElementById('token-display');
        var statusBadge = document.getElementById('login-status');
        
        responseDiv.style.display = 'block';
        resultPre.textContent = JSON.stringify(result.data, null, 2);
        statusBadge.textContent = result.status + ' ' + result.statusText;
        statusBadge.className = 'badge ' + (result.success ? 'badge-success' : '');

        // FIX: Check if login was successful by looking for access_token in the nested data
        if (result.success && result.data && result.data.data && result.data.data.access_token) {
            window.accessToken = result.data.data.access_token;
            window.refreshTokenValue = result.data.data.refresh_token;
            
            localStorage.setItem('access-token', window.accessToken);
            localStorage.setItem('refresh-token', window.refreshTokenValue);
            
            document.getElementById('user-token').value = window.accessToken;
            tokenDisplay.textContent = 'üîë Access Token: ' + window.accessToken.substring(0, 60) + '...';
            
            log('‚úÖ Login successful! Token saved to localStorage.', 'success');
        } else if (!result.success) {
            // Only show failure message if result.success is false
            var errorMsg = result.data?.message || result.message || 'Unknown error';
            log('‚ùå Login failed: ' + errorMsg, 'error');
        }
    });
}
        function verifyEmail() {
            var token = document.getElementById('verify-token').value.trim();
            if (!token) {
                log('‚ùå Please enter verification token', 'error');
                return;
            }

            apiCall('/auth/verify-email?token=' + encodeURIComponent(token)).then(function(result) {
                var responseDiv = document.getElementById('verify-response');
                var resultPre = document.getElementById('verify-result');
                var statusBadge = document.getElementById('verify-status');
                
                responseDiv.style.display = 'block';
                resultPre.textContent = JSON.stringify(result.data, null, 2);
                statusBadge.textContent = result.status + ' ' + result.statusText;
                statusBadge.className = 'badge ' + (result.success ? 'badge-success' : '');

                if (result.success) {
                    log('‚úÖ Email verified! You can now log in.', 'success');
                } else {
                    log('‚ùå Verification failed: ' + (result.data?.message || 'Invalid token'), 'error');
                }
            });
        }

        // Email Functions
        function fetchEmails() {
            var email = document.getElementById('check-email').value;
            if (!email) {
                log('‚ùå Please enter email address to check', 'error');
                return;
            }

            apiCall('/email/api/inbox?email=' + encodeURIComponent(email)).then(function(result) {
                var container = document.getElementById('email-list');
                var emails = result.data && Array.isArray(result.data) ? result.data : 
                            (result.data && result.data.data && Array.isArray(result.data.data) ? result.data.data : []);
                
                if (!result.success || emails.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No emails found for ' + email + '</p></div>';
                    log('‚ÑπÔ∏è No emails found for ' + email, 'warning');
                    return;
                }

                log('üìß Found ' + emails.length + ' email(s) for ' + email, 'success');
                
                // Auto-fill verification token
                for (var i = 0; i < emails.length; i++) {
                    if (emails[i].metadata && emails[i].metadata.token) {
                        document.getElementById('verify-token').value = emails[i].metadata.token;
                        log('‚úÖ Auto-filled verification token from email', 'success');
                        break;
                    }
                }

                container.innerHTML = emails.map(function(email) {
                    var tokenSection = '';
                    if (email.metadata && email.metadata.token) {
                        tokenSection = '<div class="token-box"><div style="margin-bottom: 8px;"><strong>üîë Verification Token:</strong></div><code>' + email.metadata.token + '</code><button class="btn btn-sm btn-primary" onclick="useToken(\'' + email.metadata.token + '\')" style="margin-top: 12px; width: 100%;">Use This Token</button></div>';
                    }
                    
                    return '<div class="email-card"><div class="email-header"><div class="email-subject">' + (email.subject || 'No Subject') + '<span class="badge ' + (email.metadata && email.metadata.type === 'verification' ? 'badge-success' : '') + '">' + (email.metadata && email.metadata.type ? email.metadata.type : 'email') + '</span></div><div class="email-meta">To: ' + email.to + ' ‚Ä¢ From: ' + email.from + ' ‚Ä¢ ' + new Date(email.sentAt).toLocaleString() + '</div></div><div class="email-body">' + tokenSection + '<div class="email-content">' + (email.html || email.text || 'No content') + '</div></div></div>';
                }).join('');
            });
        }

        function useToken(token) {
            document.getElementById('verify-token').value = token;
            switchTab('auth', document.querySelectorAll('.tab')[0]);
            log('‚úÖ Token copied to verification form', 'success');
            document.getElementById('verify-token').scrollIntoView({ behavior: 'smooth' });
        }

        function clearEmails() {
            var email = document.getElementById('check-email').value;
            apiCall('/email/clear', {
                method: 'POST',
                body: JSON.stringify(email ? { email: email } : {})
            }).then(function(result) {
                if (result.success) {
                    document.getElementById('email-list').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üóëÔ∏è</div><p>Inbox cleared</p></div>';
                    log('üóëÔ∏è Emails cleared', 'success');
                }
            });
        }

        // User Functions
        function getProfile() {
            var token = document.getElementById('user-token').value;
            if (!token) {
                log('‚ùå Please provide access token', 'error');
                return;
            }
            window.accessToken = token;
            
            apiCall('/auth/profile').then(function(result) {
                var responseDiv = document.getElementById('user-response');
                var resultPre = document.getElementById('user-result');
                var statusBadge = document.getElementById('user-status');
                
                responseDiv.style.display = 'block';
                resultPre.textContent = JSON.stringify(result.data, null, 2);
                statusBadge.textContent = result.status + ' ' + result.statusText;
                statusBadge.className = 'badge ' + (result.success ? 'badge-success' : '');
            });
        }

        function refreshAccessToken() {
            if (!window.refreshTokenValue) {
                log('‚ùå No refresh token available', 'error');
                return;
            }
            
            apiCall('/auth/refresh', {
                method: 'POST',
                body: JSON.stringify({ refreshToken: window.refreshTokenValue })
            }).then(function(result) {
                if (result.success && result.data && result.data.data && result.data.data.access_token) {
                    window.accessToken = result.data.data.access_token;
                    localStorage.setItem('access-token', window.accessToken);
                    document.getElementById('user-token').value = window.accessToken;
                    log('‚úÖ Token refreshed successfully', 'success');
                }
            });
        }

        function logout() {
            if (!window.refreshTokenValue) {
                log('‚ùå No refresh token to revoke', 'error');
                return;
            }
            
            apiCall('/auth/logout', {
                method: 'POST',
                body: JSON.stringify({ refreshToken: window.refreshTokenValue })
            }).then(function() {
                window.accessToken = '';
                window.refreshTokenValue = '';
                localStorage.removeItem('access-token');
                localStorage.removeItem('refresh-token');
                document.getElementById('user-token').value = '';
                log('üö™ Logged out successfully', 'success');
            });
        }

        // Utilities
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            
            if (element) element.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function fillRegister() {
            var random = Math.random().toString(36).substring(7);
            document.getElementById('reg-email').value = 'test' + random + '@example.com';
            document.getElementById('reg-password').value = 'password123';
            document.getElementById('reg-firstname').value = 'Test';
            document.getElementById('reg-lastname').value = 'User';
            log('üìù Auto-filled registration form', 'info');
        }

        function checkEmailInbox() {
            window.open(window.API_BASE + '/email/inbox', '_blank');
        }

        function openSwagger() {
            window.open(window.API_BASE.replace('/api/v1', '/api/docs'), '_blank');
        }

        function clearAllData() {
            localStorage.clear();
            window.accessToken = '';
            window.refreshTokenValue = '';
            log('üóëÔ∏è All local data cleared', 'warning');
            location.reload();
        }

        function setEndpoint(endpoint) {
            window.API_BASE = endpoint;
            localStorage.setItem('api-endpoint', endpoint);
            document.getElementById('api-endpoint').textContent = endpoint;
            log('üåê API endpoint changed to: ' + endpoint, 'info');
            checkApiStatus();
        }

        function checkApiStatus() {
            fetch(window.API_BASE + '/health').then(function(response) {
                var badge = document.getElementById('api-status-badge');
                var text = document.getElementById('api-status-text');
                if (response.ok) {
                    badge.className = 'status-badge status-online';
                    text.textContent = 'Connected';
                } else {
                    throw new Error('Not OK');
                }
            }).catch(function() {
                var badge = document.getElementById('api-status-badge');
                var text = document.getElementById('api-status-text');
                badge.className = 'status-badge status-offline';
                text.textContent = 'Disconnected';
            });
        }
    </script>
</body>
</html>
